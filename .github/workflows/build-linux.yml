# GitHub Actions workflow to build and release Linux packages
# ============================================================
# This workflow automatically builds RPM packages when you create a release.
#
# How to use:
# 1. Push this file to your GitHub repository
# 2. Go to GitHub > Releases > Create a new release
# 3. The workflow will automatically build and attach the RPM package

name: Build Linux Packages

on:
  release:
    types: [created]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install build dependencies
        run: |
          dnf install -y rpm-build rpmdevtools python3 python3-pip
      
      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree
      
      - name: Get version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME:-1.0.0}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Update spec file version
        run: |
          sed -i "s/^Version:.*/Version:        ${{ steps.version.outputs.VERSION }}/" linux/sleep-tracker.spec
      
      - name: Create source tarball
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p /tmp/sleep-tracker-$VERSION
          cp -r app.py database.py requirements.txt templates static linux /tmp/sleep-tracker-$VERSION/
          cp LICENSE README.md /tmp/sleep-tracker-$VERSION/ 2>/dev/null || true
          echo "MIT License" > /tmp/sleep-tracker-$VERSION/LICENSE 2>/dev/null || true
          echo "# Sleep Tracker" > /tmp/sleep-tracker-$VERSION/README.md 2>/dev/null || true
          cd /tmp
          tar czf ~/rpmbuild/SOURCES/sleep-tracker-$VERSION.tar.gz sleep-tracker-$VERSION
      
      - name: Copy spec file
        run: |
          cp linux/sleep-tracker.spec ~/rpmbuild/SPECS/
      
      - name: Build RPM
        run: |
          cd ~/rpmbuild/SPECS
          rpmbuild -ba sleep-tracker.spec
      
      - name: Upload RPM to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ~/rpmbuild/RPMS/noarch/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload RPM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sleep-tracker-rpm
          path: ~/rpmbuild/RPMS/noarch/*.rpm

  build-tarball:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME:-1.0.0}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create distribution tarball
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist/sleep-tracker-$VERSION
          
          # Copy application files
          cp app.py database.py requirements.txt dist/sleep-tracker-$VERSION/
          cp -r templates static linux dist/sleep-tracker-$VERSION/
          cp install-linux.sh uninstall-linux.sh Makefile dist/sleep-tracker-$VERSION/
          cp LICENSE README.md dist/sleep-tracker-$VERSION/ 2>/dev/null || true
          
          # Make scripts executable
          chmod +x dist/sleep-tracker-$VERSION/install-linux.sh
          chmod +x dist/sleep-tracker-$VERSION/uninstall-linux.sh
          chmod +x dist/sleep-tracker-$VERSION/linux/*.sh
          
          # Create tarball
          cd dist
          tar czf sleep-tracker-$VERSION-linux.tar.gz sleep-tracker-$VERSION
      
      - name: Upload tarball to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload tarball as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sleep-tracker-tarball
          path: dist/*.tar.gz
