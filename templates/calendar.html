{% extends "base.html" %}

{% block title %}Calendar - Sleep Tracker{% endblock %}

{% block content %}
<div class="calendar-page">
    <header class="page-header">
        <h1>Sleep Calendar</h1>
        <p class="subtitle">Each day shows the morning you woke up (sleep from the previous night)</p>
    </header>

    <!-- Month Navigation -->
    <nav class="calendar-nav card">
        <a href="{{ url_for('calendar_view', year=year, month=month-1) }}" class="nav-btn">
            ← Previous
        </a>
        <h2 class="current-month">
            {{ ['January', 'February', 'March', 'April', 'May', 'June', 
                'July', 'August', 'September', 'October', 'November', 'December'][month-1] }} 
            {{ year }}
        </h2>
        <a href="{{ url_for('calendar_view', year=year, month=month+1) }}" class="nav-btn">
            Next →
        </a>
    </nav>

    <!-- Calendar Grid -->
    <div class="calendar-container card">
        <div class="calendar-header">
            <div class="calendar-day-name">Sun</div>
            <div class="calendar-day-name">Mon</div>
            <div class="calendar-day-name">Tue</div>
            <div class="calendar-day-name">Wed</div>
            <div class="calendar-day-name">Thu</div>
            <div class="calendar-day-name">Fri</div>
            <div class="calendar-day-name">Sat</div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- Legend -->
    <div class="calendar-legend card">
        <h3>Mood Legend</h3>
        <div class="legend-items">
            <div class="legend-item">
                <span class="legend-color mood-1-2"></span>
                <span>1-2: Very Low</span>
            </div>
            <div class="legend-item">
                <span class="legend-color mood-3-4"></span>
                <span>3-4: Low</span>
            </div>
            <div class="legend-item">
                <span class="legend-color mood-5-6"></span>
                <span>5-6: Okay</span>
            </div>
            <div class="legend-item">
                <span class="legend-color mood-7-8"></span>
                <span>7-8: Good</span>
            </div>
            <div class="legend-item">
                <span class="legend-color mood-9-10"></span>
                <span>9-10: Excellent</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const year = {{ year }};
    const month = {{ month }};
    const entriesByDate = {{ entries_by_date | tojson | safe }};
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay();
    
    const grid = document.getElementById('calendarGrid');
    
    // Add empty cells for days before the 1st
    for (let i = 0; i < startDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-cell empty';
        grid.appendChild(emptyCell);
    }
    
    // Add cells for each day
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const entry = entriesByDate[dateStr];
        
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        
        // Check if today
        const today = new Date();
        if (year === today.getFullYear() && month === today.getMonth() + 1 && day === today.getDate()) {
            cell.classList.add('today');
        }
        
        // Add mood color class if we have data
        if (entry && entry.overall_mood) {
            const mood = entry.overall_mood;
            if (mood <= 2) cell.classList.add('mood-1-2');
            else if (mood <= 4) cell.classList.add('mood-3-4');
            else if (mood <= 6) cell.classList.add('mood-5-6');
            else if (mood <= 8) cell.classList.add('mood-7-8');
            else cell.classList.add('mood-9-10');
        }
        
        cell.innerHTML = `
            <span class="day-number">${day}</span>
            ${entry ? `
                <div class="cell-data">
                    ${entry.overall_mood ? `<span class="cell-mood">${entry.overall_mood}</span>` : ''}
                    ${entry.bed_time ? `<span class="cell-time">${entry.bed_time}</span>` : ''}
                </div>
            ` : ''}
        `;
        
        // Make cell clickable to edit that day
        cell.addEventListener('click', () => {
            window.location.href = `/log?date=${dateStr}`;
        });
        
        grid.appendChild(cell);
    }
</script>
{% endblock %}
