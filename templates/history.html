{% extends "base.html" %}

{% block title %}History - Sleep Tracker{% endblock %}

{% block content %}
<div class="history-page">
    <header class="page-header">
        <h1>Sleep History</h1>
        <p class="subtitle">View and edit all your past entries</p>
    </header>

    {% if entries %}
    <div class="table-container card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Bed Time</th>
                    <th>Wake Time</th>
                    <th>Duration</th>
                    <th>Wake Feeling</th>
                    <th>Overall Mood</th>
                    <th>Sleep Aids</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td class="date-cell">{{ entry.entry_date }}</td>
                    <td>{{ entry.bed_time or '—' }}</td>
                    <td>{{ entry.wake_time or '—' }}</td>
                    <td class="duration-cell" 
                        data-bed="{{ entry.bed_time }}" 
                        data-wake="{{ entry.wake_time }}">
                        —
                    </td>
                    <td>
                        <span class="mood-pill mood-{{ entry.wake_feeling or 0 }}">
                            {{ entry.wake_feeling or '—' }}
                        </span>
                    </td>
                    <td>
                        <span class="mood-pill mood-{{ entry.overall_mood or 0 }}">
                            {{ entry.overall_mood or '—' }}
                        </span>
                    </td>
                    <td class="meds-cell">
                        {% if entry.med_melatonin %}<span class="med-tag">Melatonin</span>{% endif %}
                        {% if entry.med_weed %}<span class="med-tag">Cannabis</span>{% endif %}
                        {% if entry.med_cold_medicine %}<span class="med-tag">Cold Med</span>{% endif %}
                        {% if entry.med_benadryl %}<span class="med-tag">Benadryl</span>{% endif %}
                        {% if not (entry.med_melatonin or entry.med_weed or entry.med_cold_medicine or entry.med_benadryl) %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('log_entry', date=entry.entry_date) }}" class="table-action">
                            Edit
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Summary Stats -->
    <section class="stats-summary card">
        <h2>Summary Statistics</h2>
        <div class="stats-grid" id="statsGrid">
            <!-- Populated by JavaScript -->
        </div>
    </section>

    {% else %}
    <div class="empty-state-container card">
        <p class="empty-state-message">No sleep entries yet.</p>
        <a href="{{ url_for('log_entry') }}" class="btn btn-primary">Log Your First Entry</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Calculate and display durations
    document.querySelectorAll('.duration-cell').forEach(cell => {
        const bed = cell.dataset.bed;
        const wake = cell.dataset.wake;
        
        if (bed && wake) {
            let [bedH, bedM] = bed.split(':').map(Number);
            let [wakeH, wakeM] = wake.split(':').map(Number);
            
            let bedMins = bedH * 60 + bedM;
            let wakeMins = wakeH * 60 + wakeM;
            
            if (wakeMins < bedMins) {
                wakeMins += 24 * 60;
            }
            
            const durationMins = wakeMins - bedMins;
            const hours = Math.floor(durationMins / 60);
            const mins = durationMins % 60;
            
            cell.textContent = `${hours}h ${mins}m`;
        }
    });

    // Calculate summary stats
    const entries = {{ entries | tojson | safe }};
    
    if (entries.length > 0) {
        const moods = entries.filter(e => e.overall_mood).map(e => e.overall_mood);
        const wakeFeelings = entries.filter(e => e.wake_feeling).map(e => e.wake_feeling);
        
        const avgMood = moods.length ? (moods.reduce((a, b) => a + b, 0) / moods.length).toFixed(1) : '—';
        const avgWake = wakeFeelings.length ? (wakeFeelings.reduce((a, b) => a + b, 0) / wakeFeelings.length).toFixed(1) : '—';
        
        // Count medication usage
        const melatoninCount = entries.filter(e => e.med_melatonin).length;
        const weedCount = entries.filter(e => e.med_weed).length;
        const coldMedCount = entries.filter(e => e.med_cold_medicine).length;
        const benadrylCount = entries.filter(e => e.med_benadryl).length;
        
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <span class="stat-value">${entries.length}</span>
                <span class="stat-label">Total Entries</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">${avgMood}</span>
                <span class="stat-label">Avg Mood</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">${avgWake}</span>
                <span class="stat-label">Avg Wake Feeling</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">${melatoninCount}</span>
                <span class="stat-label">Melatonin Uses</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">${weedCount}</span>
                <span class="stat-label">Cannabis Uses</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">${coldMedCount + benadrylCount}</span>
                <span class="stat-label">Other Meds</span>
            </div>
        `;
    }
</script>
{% endblock %}
